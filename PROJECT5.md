# PROJECT5.md: ボートレース「2連対」予測AI開発 要件定義書

## 1. プロジェクト基本コンセプト
「1着・2着（2連対）」を的中させることに特化し、自作AIモデルの予測精度を公式コンピューター予想や**オッズ（市場支持率）**と比較・検証する。
単なる的中率だけでなく、「市場が過小評価している2着」を炙り出し、期待値の高い予測を提供することを最終目標とする。

## 2. 予測ターゲット (Target Variable)
- **目的変数**: 各艇の「2連対（2着以内）」フラグ
    - `1`: 1着または2着で入線
    - `0`: 3着以下（着外）
- **予測出力**:
    - 各艇が2着以内に入る確率（0.0〜1.0）を出力し、確率の高い上位2艇を抽出する。

## 3. データパイプライン設計 (Data Pipeline)
データの「収集」から「予測」までを4つのフェーズに分離し、保守性と再利用性を高める。

### Phase 1: Ingestion（データ収集）
- **役割**: `pyjpboatrace` ライブラリを使用し、公式サイトからデータを取得してCSV形式で保存する。
- **出力**: `races.csv`, `entries.csv`, `results.csv`
- **制約**: **スクレイピング実行時は、必ずリクエスト間に `time.sleep(1)` 以上の待機時間を設けること。** (サーバー負荷軽減のため厳守)

### Phase 2: Transformation（データ結合・変換）
- **役割**: 収集した3つのCSVを `race_id` で結合し、機械学習モデルが扱えるフラットなテーブルに変換する。
- **処理**:
    - `entries.csv` (艇情報) に `results.csv` (着順) をJOIN。
    - 欠損値（欠場、不参加など）の除外処理。
- **出力**: `training_base.csv`

### Phase 3: Feature Engineering（特徴量生成）
- **役割**:Rawデータから予測に有効な特徴量を計算・生成する。
- **実装・検討項目**:
    - **コース別実績**: 選手ごとの該当コースでの2連対率。
    - **機力指標**: モーター2連対率、展示タイム順位。
    - **直前気象**: 風速、波高、安定板使用有無。
    - **選手属性**: 級別、今節成績（リズム）、平均ST。
    - **不一致指標**: 展示タイム順位と勝率順位のギャップ（穴狙い用）。
    - **相対評価**: 同レース内での偏差値（平均STとの差など）。

### Phase 4: Training & Evaluation（学習・評価）
- **モデル**: LightGBM (二値分類)
- **役割**: 生成したデータで学習を行い、モデルファイルを出力・評価する。
- **出力**: `model.pkl`

## 4. データスキーマと保存ルール (Data Storage)
全てのデータはCSV形式で `data/` ディレクトリに保存する。

### 4.1 共通キー (Unique Key)
全テーブルを紐づけるため、以下の `race_id` を主キーとして使用する。
- **Format**: `YYYYMMDD_SS_RR`
- **例**: `20240101_01_12` (2024年1月1日 桐生 12R)
    - `SS`: 場コード (01~24, ゼロ埋め)
    - `RR`: レース番号 (01~12, ゼロ埋め)

### 4.2 保存ファイル定義
| ファイル名 | データの粒度 | 必須カラム (一部) | 備考 |
| :--- | :--- | :--- | :--- |
| **races.csv** | 1レース/1行 | `race_id`, `date`, `stadium_id`, `race_no`, `title`, `deadline` | レース自体のメタデータ |
| **entries.csv** | 1艇/1行 | `race_id`, `boat_no`, `racer_id`, `name`, `class`, `motor_p`, `st_ave`, `fl` | **予測入力(X)** の基礎データ |
| **results.csv** | 1レース/1行 | `race_id`, `rank1_boat`, `rank2_boat`, `rank3_boat`, `payoff_3t`, `win_method` | **正解ラベル(y)** の基礎データ |

### 4.3 運用ルール
- **オッズデータ (odds.csv)**: 開発初期段階では**採用しない**。
    - 理由: データ量が膨大である点と、モデルが「人気順」に過適合するのを防ぐため。

## 5. 評価ベンチマーク (Benchmarks)
モデルの性能は以下の指標と比較して評価する。
1. **公式コンピューター予想**: 公式サイトの推奨買い目。
2. **人気順 (支持率)**: 直前オッズの1番人気〜3番人気。
3. **1-2固定**: 「1号艇1着 - 2号艇2着」の決め打ち（ボートレースの定石）。

## 6. 開発ロードマップ & TODO
- [ ] **Data**: `pyjpboatrace` を用いて、特定会場（例：大村、住之江）の過去3年分のデータを収集・CSV化。
- [ ] **Preprocess**: データの結合、クリーニング、`race_id` の付与。
- [ ] **Feature**: 特徴量エンジニアリングの実装（Phase 3）。
- [ ] **Modeling**: ベースラインモデルの学習と精度検証。
- [ ] **Inference**: 直近レースに対する推論パイプラインの構築。

## 7. 決定事項・検討事項
- **対象会場**: まずはインが強く傾向が安定している「大村」またはデータ数が多い「住之江」でベースラインを作成する。
- **学習期間**: 直近1〜2年分（モーター交換時期の影響を考慮）。
- **展示データ**: リアルタイム予測を行う場合、レース直前（締切15〜20分前）の取得が必要となるため、スクリプト実行タイミングに注意する。

## 8. 更新履歴 (Logs)
- **2026-02-19**: プロジェクト発足。ターゲットを「2連対」に設定。
- **2026-02-20**: データパイプライン設計 (Phase 1-4) を策定。CSVスキーマ定義。
